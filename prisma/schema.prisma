// Prisma schema for Jobly
// Using PostgreSQL via Neon.tech with connection pooling
// Schema version: 2026-01-19 - Added security models for RBAC and tenant isolation

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User role enumeration
enum UserRole {
  EMPLOYEE
  EMPLOYER
}

// Employer role within a tenant (hierarchical)
enum EmployerRole {
  EMPLOYER_OWNER      // Full control, can delete tenant
  EMPLOYER_ADMIN      // Manage team, settings, all operations
  EMPLOYER_RECRUITER  // Manage jobs, applicants, messages
  EMPLOYER_VIEWER     // Read-only access
}

// Job approval status
enum JobApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

// Invitation status
enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// Super Admin model for platform administrators
model SuperAdmin {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String
  role          String   @default("super_admin") // super_admin, moderator
  avatar        String?

  // Permissions (JSON for flexibility)
  permissions   Json?    // { canApproveJobs: true, canManageUsers: true, ... }

  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("super_admins")
}

// Multi-tenant architecture: Tenant/Organization model
model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  coverImage  String?
  website     String?
  industry    String?
  size        String?  // e.g., "1-10", "11-50", "51-200", "201-500", "500+"
  foundedYear Int?

  // Contact Information
  email       String?
  phone       String?

  // Location
  address     String?
  city        String?
  province    String?
  postalCode  String?
  country     String?  @default("Philippines")

  // Social Links
  linkedinUrl  String?
  facebookUrl  String?
  twitterUrl   String?
  instagramUrl String?

  // Company Culture
  mission      String?
  vision       String?
  benefits     String[]  // Company benefits/perks
  culture      String?   // Company culture description

  // Verification
  isVerified   Boolean  @default(false)
  verifiedAt   DateTime?

  // Admin control
  isSuspended      Boolean  @default(false)
  suspendedAt      DateTime?
  suspensionReason String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       User[]
  jobs        Job[]
  reviews     CompanyReview[]
  members     TenantMember[]
  invitations TenantInvitation[]

  @@map("tenants")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          UserRole
  avatar        String?
  phone         String?
  bio           String?
  location      String?

  // Employee-specific fields
  title         String?   // Job title (for employees)
  skills        String[]  // Skills array (for employees)
  resumeUrl     String?
  linkedinUrl   String?
  portfolioUrl  String?
  githubUrl     String?
  websiteUrl    String?
  yearsOfExp    Int?

  // Additional personal info
  dateOfBirth   DateTime?
  gender        String?
  nationality   String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String?   @default("Philippines")

  // Job preferences
  expectedSalary      String?
  preferredJobType    String?   // full-time, part-time, contract, freelance
  preferredWorkSetup  String?   // remote, onsite, hybrid
  availableFrom       DateTime?
  willingToRelocate   Boolean   @default(false)
  openToOffers        Boolean   @default(true)

  // Notification preferences (stored as JSON)
  notificationSettings Json?

  // Common fields
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auth fields
  emailVerified DateTime?
  lastLoginAt   DateTime?
  isActive      Boolean   @default(true)

  // Admin control
  isSuspended      Boolean  @default(false)
  suspendedAt      DateTime?
  suspensionReason String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  applications    Application[]
  savedJobs       SavedJob[]
  workExperiences WorkExperience[]
  educations      Education[]
  certifications  Certification[]
  languages       Language[]
  references      Reference[]
  notifications   Notification[]
  resumes         Resume[]

  // Talent Pool relations (for job seekers)
  talentPoolProfile    TalentPoolProfile?
  receivedInvites      InterviewInvite[]   @relation("ReceivedInvites")
  sentMessagesAsSeeker Message[]           @relation("SeekerMessages")
  receivedMessagesAsSeeker Message[]       @relation("EmployerToSeekerMessages")

  // Employer-side talent pool relations
  shortlists           EmployerShortlist[]
  sentInvites          InterviewInvite[]   @relation("SentInvites")
  profileViews         ProfileView[]       @relation("ViewerProfile")
  profileViewsReceived ProfileView[]       @relation("ViewedProfile")
  candidateBlocks      CandidateBlock[]

  // New feature relations
  jobAlerts            JobAlert[]
  companyReviews       CompanyReview[]
  salaryReports        SalaryReport[]

  // Security: Tenant memberships (for employers with team access)
  tenantMemberships    TenantMember[]
  securitySessions     SecuritySession[]

  // Career development
  careerGoals          CareerGoal[]
  interviewPreps       InterviewPrep[]

  // Social login
  oauthAccounts        OAuthAccount[]

  @@index([tenantId])
  @@index([role])
  @@index([email])
  @@index([openToOffers])
  @@map("users")
}

model Job {
  id           String   @id @default(cuid())
  title        String
  description  String
  requirements String?
  location     String?
  locationType String?  // "remote", "onsite", "hybrid"
  salary       String?
  jobType      String?  // "full-time", "part-time", "contract", "internship"
  department   String?
  isActive     Boolean  @default(true)
  expiresAt    DateTime?

  // Admin approval workflow
  approvalStatus   JobApprovalStatus @default(PENDING)
  approvedAt       DateTime?
  approvedBy       String?           // SuperAdmin ID who approved
  rejectionReason  String?

  // Featured/promoted
  isFeatured       Boolean  @default(false)
  featuredUntil    DateTime?

  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  applications     Application[]
  savedJobs        SavedJob[]
  screeningForms   ScreeningForm[]
  interviewInvites InterviewInvite[]

  @@index([tenantId])
  @@index([isActive])
  @@index([approvalStatus])
  @@map("jobs")
}

// Question type enumeration for screening forms
enum QuestionType {
  YES_NO
  SINGLE_SELECT
  MULTI_SELECT
  SHORT_TEXT
  LONG_TEXT
  NUMBER
  DATE
  SALARY_EXPECTATION
  YEARS_OF_EXPERIENCE
  AVAILABILITY
  WORK_AUTHORIZATION
  URL_LIST
  FILE_UPLOAD
}

// Rule type enumeration
enum RuleType {
  KNOCKOUT      // If condition met, auto-reject
  SCORE         // Add/subtract points based on answer
}

// Rule operator enumeration
enum RuleOperator {
  EQUALS
  NOT_EQUALS
  CONTAINS
  NOT_CONTAINS
  GREATER_THAN
  LESS_THAN
  GREATER_THAN_OR_EQUAL
  LESS_THAN_OR_EQUAL
  IN_LIST
  NOT_IN_LIST
  IS_EMPTY
  IS_NOT_EMPTY
}

// Screening form - versioned per job
model ScreeningForm {
  id          String   @id @default(cuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  version     Int      @default(1)
  isActive    Boolean  @default(true)
  title       String?
  description String?

  // Scoring thresholds
  shortlistThreshold  Int?     // Score >= this = Shortlisted
  passingThreshold    Int?     // Score >= this = Passed (but not shortlisted)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions   ScreeningQuestion[]
  applications Application[]

  @@unique([jobId, version])
  @@index([jobId])
  @@index([isActive])
  @@map("screening_forms")
}

// Screening question
model ScreeningQuestion {
  id            String       @id @default(cuid())
  formId        String
  form          ScreeningForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  questionText  String
  questionType  QuestionType
  order         Int          @default(0)
  isRequired    Boolean      @default(false)

  // Configuration stored as JSON
  // For select types: { "choices": ["Option 1", "Option 2"] }
  // For number: { "min": 0, "max": 100 }
  // For text: { "minLength": 10, "maxLength": 500, "regex": "^[a-z]+$" }
  // For salary: { "currency": "PHP", "period": "monthly" }
  // For file: { "maxSize": 5242880, "allowedTypes": ["pdf", "doc"] }
  config        Json?

  // Help text shown to applicant
  helpText      String?

  // Placeholder text for input fields
  placeholder   String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  rules         ScreeningRule[]
  answers       ScreeningAnswer[]

  @@index([formId])
  @@index([order])
  @@map("screening_questions")
}

// Screening rule - for knockout and scoring
model ScreeningRule {
  id          String       @id @default(cuid())
  questionId  String
  question    ScreeningQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  ruleType    RuleType
  operator    RuleOperator

  // The value to compare against (stored as JSON for flexibility)
  // For simple values: "yes", 5, "2024-01-01"
  // For lists: ["Option 1", "Option 2"]
  value       Json

  // For SCORE type: points to add (positive) or subtract (negative)
  scoreValue  Int?

  // Optional message shown when rule triggers (for knockout)
  message     String?

  // Priority for rule evaluation (lower = evaluated first)
  priority    Int          @default(0)

  isActive    Boolean      @default(true)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([questionId])
  @@index([ruleType])
  @@map("screening_rules")
}

// Screening answer - stores applicant responses
model ScreeningAnswer {
  id            String       @id @default(cuid())
  applicationId String
  application   Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  questionId    String
  question      ScreeningQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // Answer stored as JSON for flexibility
  // For yes/no: true/false
  // For select: "Option 1" or ["Option 1", "Option 2"]
  // For text: "answer text"
  // For number: 5
  // For date: "2024-01-01"
  // For salary: { "amount": 50000, "currency": "PHP", "period": "monthly" }
  // For file: { "url": "...", "filename": "resume.pdf", "size": 1024 }
  answer        Json

  // Cached rule evaluation results
  isKnockout    Boolean      @default(false)
  scoreEarned   Int          @default(0)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([applicationId, questionId])
  @@index([applicationId])
  @@index([questionId])
  @@map("screening_answers")
}

model Application {
  id          String   @id @default(cuid())
  status      String   @default("new") // new, shortlisted, reviewing, interviewed, offered, rejected
  coverLetter String?
  resumeUrl   String?
  notes       String?

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Screening form tracking
  screeningFormId  String?
  screeningForm    ScreeningForm? @relation(fields: [screeningFormId], references: [id], onDelete: SetNull)

  // Screening results
  screeningScore   Int?           // Total score from screening
  hasKnockout      Boolean        @default(false)  // True if any knockout rule triggered
  knockoutReason   String?        // Reason for knockout (question that triggered it)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  screeningAnswers ScreeningAnswer[]

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@index([status])
  @@index([screeningFormId])
  @@index([screeningScore])
  @@map("applications")
}

model SavedJob {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, jobId])
  @@index([userId])
  @@map("saved_jobs")
}

// Work Experience for employee profiles
model WorkExperience {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  jobTitle        String
  company         String
  companyLogo     String?
  location        String?
  locationType    String?   // remote, onsite, hybrid
  employmentType  String?   // full-time, part-time, contract, internship, freelance
  startDate       DateTime
  endDate         DateTime?
  isCurrent       Boolean   @default(false)
  description     String?
  achievements    String[]
  skills          String[]  // Skills used in this role

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@map("work_experiences")
}

// Education for employee profiles
model Education {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  school          String
  schoolLogo      String?
  degree          String    // Bachelor's, Master's, PhD, etc.
  fieldOfStudy    String
  startDate       DateTime
  endDate         DateTime?
  isCurrent       Boolean   @default(false)
  grade           String?   // GPA or equivalent
  activities      String?   // Extracurricular activities
  description     String?
  achievements    String[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@map("educations")
}

// Certifications and licenses
model Certification {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name              String
  issuingOrg        String
  issuingOrgLogo    String?
  issueDate         DateTime
  expiryDate        DateTime?
  hasNoExpiry       Boolean   @default(false)
  credentialId      String?
  credentialUrl     String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@map("certifications")
}

// Languages spoken
model Language {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  language        String
  proficiency     String   // Native, Fluent, Advanced, Intermediate, Basic

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("languages")
}

// Professional references
model Reference {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  position        String
  company         String
  email           String?
  phone           String?
  relationship    String   // Former Manager, Colleague, Client, etc.

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("references")
}

// User notifications
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String   // application_viewed, application_status, interview_scheduled, message_received, job_alert, offer_received, etc.
  title     String
  message   String
  link      String?  // Optional link to relevant page
  isRead    Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}

// Super Admin notifications
model SuperAdminNotification {
  id        String   @id @default(cuid())

  type      String   // new_user, new_employer, new_job, job_pending, employer_verification, user_suspended, etc.
  title     String
  message   String
  link      String?  // Optional link to relevant page (e.g., /superadmin/users/123)
  isRead    Boolean  @default(false)

  // Optional references for quick access
  relatedUserId     String?
  relatedTenantId   String?
  relatedJobId      String?

  // Metadata for additional context
  metadata  Json?    // { userName, companyName, jobTitle, etc. }

  createdAt DateTime @default(now())

  @@index([isRead])
  @@index([type])
  @@index([createdAt])
  @@map("super_admin_notifications")
}

// ==========================================
// TALENT POOL FEATURE MODELS
// ==========================================

// Job seeker's talent pool visibility settings
model TalentPoolProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Visibility controls
  isVisible             Boolean  @default(false)  // Allow employers to find this profile
  minProfileCompleteness Int     @default(80)     // Minimum % to be visible

  // Availability settings
  availability          String?  // immediate, 2_weeks, 1_month, 3_months, not_looking
  experienceLevel       String?  // entry, junior, mid, senior, lead, manager

  // Additional searchable fields (cached for performance)
  primarySkills         String[] // Top skills for filtering
  preferredLocations    String[] // Cities/countries willing to work in
  remotePreference      String?  // remote_only, hybrid, onsite, flexible

  // Activity tracking
  lastActiveAt          DateTime @default(now())
  profileViewsCount     Int      @default(0)
  searchAppearances     Int      @default(0)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([isVisible])
  @@index([availability])
  @@index([experienceLevel])
  @@index([lastActiveAt])
  @@map("talent_pool_profiles")
}

// Employer's shortlist collections
model EmployerShortlist {
  id          String   @id @default(cuid())
  employerId  String
  employer    User     @relation(fields: [employerId], references: [id], onDelete: Cascade)

  name        String   // e.g., "Frontend Developers", "Sales Team"
  description String?
  color       String?  // For UI organization

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  candidates  ShortlistCandidate[]

  @@index([employerId])
  @@map("employer_shortlists")
}

// Candidates saved to shortlists
model ShortlistCandidate {
  id            String   @id @default(cuid())
  shortlistId   String
  shortlist     EmployerShortlist @relation(fields: [shortlistId], references: [id], onDelete: Cascade)

  candidateId   String   // The job seeker's user ID
  notes         String?  // Private notes by employer
  rating        Int?     // 1-5 star rating

  addedAt       DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([shortlistId, candidateId])
  @@index([shortlistId])
  @@index([candidateId])
  @@map("shortlist_candidates")
}

// Interview invitations sent to candidates
model InterviewInvite {
  id              String   @id @default(cuid())

  // Sender (employer)
  employerId      String
  employer        User     @relation("SentInvites", fields: [employerId], references: [id], onDelete: Cascade)

  // Recipient (job seeker)
  candidateId     String
  candidate       User     @relation("ReceivedInvites", fields: [candidateId], references: [id], onDelete: Cascade)

  // Optional job reference
  jobId           String?
  job             Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)

  // Invite details
  type            String   @default("general") // general, job_specific
  message         String?
  proposedDates   Json?    // Array of proposed date/times

  // Status tracking
  status          String   @default("pending") // pending, accepted, declined, expired
  respondedAt     DateTime?
  responseMessage String?

  expiresAt       DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([employerId])
  @@index([candidateId])
  @@index([jobId])
  @@index([status])
  @@map("interview_invites")
}

// Internal messaging between employers and candidates
model Message {
  id          String   @id @default(cuid())

  // Sender (can be either employer or job seeker)
  senderId    String
  sender      User     @relation("SeekerMessages", fields: [senderId], references: [id], onDelete: Cascade)

  // Recipient
  recipientId String
  recipient   User     @relation("EmployerToSeekerMessages", fields: [recipientId], references: [id], onDelete: Cascade)

  // Thread reference (for conversation grouping)
  threadId    String?
  parentId    String?  // For reply chains

  subject     String?
  content     String
  isRead      Boolean  @default(false)

  // Optional context
  jobId       String?  // Related job posting
  inviteId    String?  // Related interview invite

  createdAt   DateTime @default(now())
  readAt      DateTime?

  @@index([senderId])
  @@index([recipientId])
  @@index([threadId])
  @@index([isRead])
  @@map("messages")
}

// Track profile views for analytics
model ProfileView {
  id          String   @id @default(cuid())

  viewerId    String   // Employer who viewed
  viewer      User     @relation("ViewerProfile", fields: [viewerId], references: [id], onDelete: Cascade)

  viewedId    String   // Job seeker whose profile was viewed
  viewed      User     @relation("ViewedProfile", fields: [viewedId], references: [id], onDelete: Cascade)

  viewedAt    DateTime @default(now())

  // Analytics
  source      String?  // search, shortlist, recommendation
  timeSpent   Int?     // Seconds spent on profile

  @@index([viewerId])
  @@index([viewedId])
  @@index([viewedAt])
  @@map("profile_views")
}

// Block/hide candidates from employer's view
model CandidateBlock {
  id          String   @id @default(cuid())
  employerId  String
  employer    User     @relation(fields: [employerId], references: [id], onDelete: Cascade)

  candidateId String   // Job seeker to block
  reason      String?

  createdAt   DateTime @default(now())

  @@unique([employerId, candidateId])
  @@index([employerId])
  @@map("candidate_blocks")
}

// Saved filter sets for employers
model SavedFilter {
  id          String   @id @default(cuid())
  employerId  String

  name        String   // e.g., "Senior React Developers â€“ Remote"
  filters     Json     // Serialized filter configuration

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([employerId])
  @@map("saved_filters")
}

// User uploaded resumes
model Resume {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  filename        String
  fileSize        Int      // Size in bytes
  mimeType        String   // application/pdf, application/msword, etc.
  dataUrl         String   @db.Text  // Base64 data URL for file content
  extractedSkills String[] // Skills extracted from resume

  isPrimary       Boolean  @default(false) // Primary resume for applications

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("resumes")
}

// ==========================================
// JOB ALERTS FEATURE
// ==========================================

model JobAlert {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String   // User-defined name for the alert
  isActive        Boolean  @default(true)

  // Search criteria (stored as JSON for flexibility)
  keywords        String[] // Job title keywords
  locations       String[] // Locations to search
  jobTypes        String[] // full-time, part-time, contract, etc.
  salaryMin       Int?
  salaryMax       Int?
  remoteOnly      Boolean  @default(false)
  industries      String[] // Industry filters
  experienceLevel String?  // entry, mid, senior, etc.

  // Notification settings
  frequency       String   @default("daily") // instant, daily, weekly
  emailEnabled    Boolean  @default(true)
  lastSentAt      DateTime?
  lastJobCount    Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
  @@map("job_alerts")
}

// ==========================================
// COMPANY REVIEWS FEATURE
// ==========================================

model CompanyReview {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Review type
  reviewType      String   // employee, former_employee, interviewed, applicant

  // Ratings (1-5 scale)
  overallRating       Float
  workLifeBalance     Float?
  compensation        Float?
  jobSecurity         Float?
  management          Float?
  culture             Float?
  careerGrowth        Float?

  // Review content
  title           String
  pros            String
  cons            String
  advice          String?  // Advice to management

  // Employment details (optional)
  jobTitle        String?
  department      String?
  employmentStatus String?  // current, former
  employmentType  String?  // full-time, part-time, contract, intern
  yearsAtCompany  Int?

  // Location
  location        String?

  // Moderation
  isApproved      Boolean  @default(false)
  approvedAt      DateTime?
  approvedBy      String?  // SuperAdmin ID
  isHidden        Boolean  @default(false)
  hiddenReason    String?

  // Helpful votes
  helpfulCount    Int      @default(0)
  notHelpfulCount Int      @default(0)

  // Employer response
  employerResponse    String?
  employerRespondedAt DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  votes           ReviewVote[]

  @@index([tenantId])
  @@index([userId])
  @@index([isApproved])
  @@index([overallRating])
  @@map("company_reviews")
}

model ReviewVote {
  id          String   @id @default(cuid())
  reviewId    String
  review      CompanyReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  userId      String
  isHelpful   Boolean  // true = helpful, false = not helpful

  createdAt   DateTime @default(now())

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@map("review_votes")
}

// ==========================================
// AUDIT LOGGING FEATURE
// ==========================================

model AuditLog {
  id          String   @id @default(cuid())

  // Who performed the action
  actorType   String   // super_admin, employer, employee, system
  actorId     String?  // User or SuperAdmin ID
  actorEmail  String?
  actorName   String?

  // What action was performed
  action      String   // create, update, delete, login, logout, approve, reject, suspend, etc.
  resource    String   // user, job, application, tenant, settings, etc.
  resourceId  String?

  // Details
  description String?
  metadata    Json?    // Additional context (old values, new values, etc.)

  // Request info
  ipAddress   String?
  userAgent   String?
  requestId   String?  // For request tracing

  // Categorization
  category    String?  // authentication, data_modification, admin_action, security, etc.
  severity    String   @default("info") // info, warning, error, critical

  createdAt   DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([createdAt])
  @@index([category])
  @@index([severity])
  @@map("audit_logs")
}

// ==========================================
// TWO-FACTOR AUTHENTICATION
// ==========================================

model TwoFactorAuth {
  id              String   @id @default(cuid())

  // Can be either User or SuperAdmin
  userType        String   // user, super_admin
  userId          String   @unique

  // TOTP settings
  secret          String   // Encrypted TOTP secret
  isEnabled       Boolean  @default(false)
  verifiedAt      DateTime?

  // Backup codes (hashed)
  backupCodes     String[] // Hashed backup codes
  backupCodesUsed Int      @default(0)

  // Recovery
  recoveryEmail   String?
  recoveryPhone   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([userType])
  @@map("two_factor_auth")
}

// ==========================================
// SALARY INSIGHTS FEATURE
// ==========================================

model SalaryReport {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Job details
  jobTitle        String
  normalizedTitle String   // For grouping similar titles
  tenantId        String?  // Optional company link
  companyName     String?  // For anonymous reports

  // Salary info
  baseSalary      Int
  currency        String   @default("PHP")
  salaryPeriod    String   @default("yearly") // yearly, monthly, hourly
  totalCompensation Int?   // Including bonuses, stock, etc.

  // Compensation breakdown
  bonus           Int?
  stockOptions    Int?
  commission      Int?
  otherBenefits   String?

  // Job details
  location        String?
  yearsExperience Int?
  yearsAtCompany  Int?
  employmentType  String?  // full-time, part-time, contract
  department      String?

  // Education
  educationLevel  String?  // high_school, bachelors, masters, phd

  // Verification
  isVerified      Boolean  @default(false)
  verifiedAt      DateTime?

  // Moderation
  isApproved      Boolean  @default(true)
  isHidden        Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([normalizedTitle])
  @@index([location])
  @@index([baseSalary])
  @@index([tenantId])
  @@map("salary_reports")
}

// ==========================================
// SECURITY: TENANT TEAM MANAGEMENT
// ==========================================

// Employer Team Membership - Links users to tenants with specific roles
model TenantMember {
  id          String   @id @default(cuid())

  // User (must be EMPLOYER type)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Tenant they belong to
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Role within the tenant
  role        EmployerRole @default(EMPLOYER_VIEWER)

  // Invitation tracking
  invitedBy   String?      // User ID who sent the invite
  invitedAt   DateTime     @default(now())
  acceptedAt  DateTime?

  // Status
  isActive    Boolean  @default(true)
  deactivatedAt DateTime?
  deactivatedBy String?
  deactivationReason String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([role])
  @@index([isActive])
  @@map("tenant_members")
}

// Invitation for joining a tenant
model TenantInvitation {
  id          String   @id @default(cuid())

  // Target tenant
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Invitation details
  email       String
  role        EmployerRole @default(EMPLOYER_VIEWER)

  // Token for accepting invitation
  token       String   @unique @default(cuid())
  expiresAt   DateTime

  // Who sent it
  invitedBy   String
  inviterName String?

  // Personalized message
  message     String?

  // Status
  status      InvitationStatus @default(PENDING)
  acceptedAt  DateTime?
  revokedAt   DateTime?
  revokedBy   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("tenant_invitations")
}

// ==========================================
// SECURITY: SESSION MANAGEMENT
// ==========================================

// Security Session - Track active sessions for audit and revocation
model SecuritySession {
  id          String   @id @default(cuid())

  // User or Super Admin
  userType    String   // user, super_admin
  userId      String
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session details
  tokenHash   String   // Hashed JWT token for identification
  ipAddress   String?
  userAgent   String?
  deviceInfo  Json?    // { browser, os, device, location }

  // Activity tracking
  lastActiveAt DateTime @default(now())
  expiresAt    DateTime

  // Revocation
  isRevoked    Boolean  @default(false)
  revokedAt    DateTime?
  revokedBy    String?  // User/Admin who revoked
  revokeReason String?

  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([userType])
  @@index([tokenHash])
  @@index([isRevoked])
  @@index([expiresAt])
  @@map("security_sessions")
}

// ==========================================
// SECURITY: RATE LIMITING
// ==========================================

// Rate Limiting - Track request rates per user/IP to prevent abuse
model RateLimitEntry {
  id          String   @id @default(cuid())

  // Identifier (can be user ID, IP, or combination like "user:123" or "ip:1.2.3.4")
  identifier  String
  endpoint    String   // API endpoint being rate limited

  // Counters
  requestCount Int     @default(1)
  windowStart  DateTime @default(now())
  windowEnd    DateTime

  // Blocking
  isBlocked    Boolean  @default(false)
  blockedUntil DateTime?
  blockReason  String?

  createdAt    DateTime @default(now())

  @@unique([identifier, endpoint])
  @@index([identifier])
  @@index([endpoint])
  @@index([windowEnd])
  @@index([isBlocked])
  @@map("rate_limit_entries")
}

// ==========================================
// CAREER GOALS TRACKER
// ==========================================

// Career goal set by job seeker
model CareerGoal {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Goal details
  title           String   // e.g., "Become a Senior Developer"
  targetRole      String   // Target job title
  targetIndustry  String?  // Target industry
  targetSalary    Int?     // Target salary
  targetCompanies String[] // Dream companies

  // Timeline
  targetDate      DateTime?
  priority        String   @default("medium") // low, medium, high

  // Progress tracking
  status          String   @default("active") // active, achieved, paused, abandoned
  progressPercent Int      @default(0)
  achievedAt      DateTime?

  // Notes
  description     String?
  motivation      String?  // Why this goal matters

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  milestones      CareerMilestone[]
  skillTargets    SkillTarget[]

  @@index([userId])
  @@index([status])
  @@map("career_goals")
}

// Milestones within a career goal
model CareerMilestone {
  id          String   @id @default(cuid())
  goalId      String
  goal        CareerGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  title       String
  description String?
  dueDate     DateTime?

  // Status
  isCompleted Boolean  @default(false)
  completedAt DateTime?

  // Order
  order       Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([goalId])
  @@map("career_milestones")
}

// Skill targets for career goals
model SkillTarget {
  id              String   @id @default(cuid())
  goalId          String
  goal            CareerGoal @relation(fields: [goalId], references: [id], onDelete: Cascade)

  skillName       String
  currentLevel    String?  // beginner, intermediate, advanced, expert
  targetLevel     String   // intermediate, advanced, expert

  // Progress
  isAchieved      Boolean  @default(false)
  achievedAt      DateTime?

  // Resources
  learningResources Json?  // [{ title, url, type }]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([goalId])
  @@map("skill_targets")
}

// ==========================================
// INTERVIEW PREPARATION
// ==========================================

// Interview prep sessions
model InterviewPrep {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Context
  companyName     String?
  jobTitle        String?
  interviewDate   DateTime?
  interviewType   String?  // phone, video, onsite, technical, behavioral

  // Prep content
  companyNotes    String?  // Research notes about company
  roleNotes       String?  // Notes about the role
  questionsToAsk  String[] // Questions to ask interviewer

  // Status
  status          String   @default("preparing") // preparing, completed, archived

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  practiceQuestions InterviewQuestion[]

  @@index([userId])
  @@index([interviewDate])
  @@map("interview_preps")
}

// Interview practice questions
model InterviewQuestion {
  id              String   @id @default(cuid())
  prepId          String?
  prep            InterviewPrep? @relation(fields: [prepId], references: [id], onDelete: Cascade)

  // Question details
  question        String
  category        String   // behavioral, technical, situational, company-specific
  difficulty      String   @default("medium") // easy, medium, hard

  // User's answer/notes
  myAnswer        String?
  notes           String?

  // Practice tracking
  practiceCount   Int      @default(0)
  lastPracticedAt DateTime?
  confidence      Int?     // 1-5 rating

  // For global question bank (prepId = null)
  isGlobal        Boolean  @default(false)
  industry        String?
  jobRole         String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([prepId])
  @@index([category])
  @@index([isGlobal])
  @@map("interview_questions")
}

// ==========================================
// SOCIAL LOGIN
// ==========================================

// OAuth accounts linked to users
model OAuthAccount {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  provider        String   // google, linkedin
  providerAccountId String

  // Tokens (encrypted)
  accessToken     String?
  refreshToken    String?
  expiresAt       DateTime?

  // Profile data from provider
  email           String?
  name            String?
  avatar          String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("oauth_accounts")
}
