// Prisma schema for Jobly
// Using PostgreSQL via Neon.tech with connection pooling

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User role enumeration
enum UserRole {
  EMPLOYEE
  EMPLOYER
}

// Multi-tenant architecture: Tenant/Organization model
model Tenant {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logo        String?
  coverImage  String?
  website     String?
  industry    String?
  size        String?  // e.g., "1-10", "11-50", "51-200", "201-500", "500+"
  foundedYear Int?

  // Contact Information
  email       String?
  phone       String?

  // Location
  address     String?
  city        String?
  province    String?
  postalCode  String?
  country     String?  @default("Philippines")

  // Social Links
  linkedinUrl  String?
  facebookUrl  String?
  twitterUrl   String?
  instagramUrl String?

  // Company Culture
  mission      String?
  vision       String?
  benefits     String[]  // Company benefits/perks
  culture      String?   // Company culture description

  // Verification
  isVerified   Boolean  @default(false)
  verifiedAt   DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users User[]
  jobs  Job[]

  @@map("tenants")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          UserRole
  avatar        String?
  phone         String?
  bio           String?
  location      String?

  // Employee-specific fields
  title         String?   // Job title (for employees)
  skills        String[]  // Skills array (for employees)
  resumeUrl     String?
  linkedinUrl   String?
  portfolioUrl  String?
  githubUrl     String?
  websiteUrl    String?
  yearsOfExp    Int?

  // Additional personal info
  dateOfBirth   DateTime?
  gender        String?
  nationality   String?
  address       String?
  city          String?
  province      String?
  postalCode    String?
  country       String?   @default("Philippines")

  // Job preferences
  expectedSalary      String?
  preferredJobType    String?   // full-time, part-time, contract, freelance
  preferredWorkSetup  String?   // remote, onsite, hybrid
  availableFrom       DateTime?
  willingToRelocate   Boolean   @default(false)
  openToOffers        Boolean   @default(true)

  // Common fields
  tenantId      String?
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Auth fields
  emailVerified DateTime?
  lastLoginAt   DateTime?
  isActive      Boolean   @default(true)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  applications    Application[]
  savedJobs       SavedJob[]
  workExperiences WorkExperience[]
  educations      Education[]
  certifications  Certification[]
  languages       Language[]
  references      Reference[]
  notifications   Notification[]

  @@index([tenantId])
  @@index([role])
  @@index([email])
  @@map("users")
}

model Job {
  id           String   @id @default(cuid())
  title        String
  description  String
  requirements String?
  location     String?
  locationType String?  // "remote", "onsite", "hybrid"
  salary       String?
  jobType      String?  // "full-time", "part-time", "contract", "internship"
  department   String?
  isActive     Boolean  @default(true)
  expiresAt    DateTime?

  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  applications    Application[]
  savedJobs       SavedJob[]
  screeningForms  ScreeningForm[]

  @@index([tenantId])
  @@index([isActive])
  @@map("jobs")
}

// Question type enumeration for screening forms
enum QuestionType {
  YES_NO
  SINGLE_SELECT
  MULTI_SELECT
  SHORT_TEXT
  LONG_TEXT
  NUMBER
  DATE
  SALARY_EXPECTATION
  YEARS_OF_EXPERIENCE
  AVAILABILITY
  WORK_AUTHORIZATION
  URL_LIST
  FILE_UPLOAD
}

// Rule type enumeration
enum RuleType {
  KNOCKOUT      // If condition met, auto-reject
  SCORE         // Add/subtract points based on answer
}

// Rule operator enumeration
enum RuleOperator {
  EQUALS
  NOT_EQUALS
  CONTAINS
  NOT_CONTAINS
  GREATER_THAN
  LESS_THAN
  GREATER_THAN_OR_EQUAL
  LESS_THAN_OR_EQUAL
  IN_LIST
  NOT_IN_LIST
  IS_EMPTY
  IS_NOT_EMPTY
}

// Screening form - versioned per job
model ScreeningForm {
  id          String   @id @default(cuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  version     Int      @default(1)
  isActive    Boolean  @default(true)
  title       String?
  description String?

  // Scoring thresholds
  shortlistThreshold  Int?     // Score >= this = Shortlisted
  passingThreshold    Int?     // Score >= this = Passed (but not shortlisted)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions   ScreeningQuestion[]
  applications Application[]

  @@unique([jobId, version])
  @@index([jobId])
  @@index([isActive])
  @@map("screening_forms")
}

// Screening question
model ScreeningQuestion {
  id            String       @id @default(cuid())
  formId        String
  form          ScreeningForm @relation(fields: [formId], references: [id], onDelete: Cascade)

  questionText  String
  questionType  QuestionType
  order         Int          @default(0)
  isRequired    Boolean      @default(false)

  // Configuration stored as JSON
  // For select types: { "choices": ["Option 1", "Option 2"] }
  // For number: { "min": 0, "max": 100 }
  // For text: { "minLength": 10, "maxLength": 500, "regex": "^[a-z]+$" }
  // For salary: { "currency": "PHP", "period": "monthly" }
  // For file: { "maxSize": 5242880, "allowedTypes": ["pdf", "doc"] }
  config        Json?

  // Help text shown to applicant
  helpText      String?

  // Placeholder text for input fields
  placeholder   String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  rules         ScreeningRule[]
  answers       ScreeningAnswer[]

  @@index([formId])
  @@index([order])
  @@map("screening_questions")
}

// Screening rule - for knockout and scoring
model ScreeningRule {
  id          String       @id @default(cuid())
  questionId  String
  question    ScreeningQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  ruleType    RuleType
  operator    RuleOperator

  // The value to compare against (stored as JSON for flexibility)
  // For simple values: "yes", 5, "2024-01-01"
  // For lists: ["Option 1", "Option 2"]
  value       Json

  // For SCORE type: points to add (positive) or subtract (negative)
  scoreValue  Int?

  // Optional message shown when rule triggers (for knockout)
  message     String?

  // Priority for rule evaluation (lower = evaluated first)
  priority    Int          @default(0)

  isActive    Boolean      @default(true)

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([questionId])
  @@index([ruleType])
  @@map("screening_rules")
}

// Screening answer - stores applicant responses
model ScreeningAnswer {
  id            String       @id @default(cuid())
  applicationId String
  application   Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  questionId    String
  question      ScreeningQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // Answer stored as JSON for flexibility
  // For yes/no: true/false
  // For select: "Option 1" or ["Option 1", "Option 2"]
  // For text: "answer text"
  // For number: 5
  // For date: "2024-01-01"
  // For salary: { "amount": 50000, "currency": "PHP", "period": "monthly" }
  // For file: { "url": "...", "filename": "resume.pdf", "size": 1024 }
  answer        Json

  // Cached rule evaluation results
  isKnockout    Boolean      @default(false)
  scoreEarned   Int          @default(0)

  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([applicationId, questionId])
  @@index([applicationId])
  @@index([questionId])
  @@map("screening_answers")
}

model Application {
  id          String   @id @default(cuid())
  status      String   @default("new") // new, shortlisted, reviewing, interviewed, offered, rejected
  coverLetter String?
  resumeUrl   String?
  notes       String?

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Screening form tracking
  screeningFormId  String?
  screeningForm    ScreeningForm? @relation(fields: [screeningFormId], references: [id], onDelete: SetNull)

  // Screening results
  screeningScore   Int?           // Total score from screening
  hasKnockout      Boolean        @default(false)  // True if any knockout rule triggered
  knockoutReason   String?        // Reason for knockout (question that triggered it)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  screeningAnswers ScreeningAnswer[]

  @@unique([userId, jobId])
  @@index([userId])
  @@index([jobId])
  @@index([status])
  @@index([screeningFormId])
  @@index([screeningScore])
  @@map("applications")
}

model SavedJob {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, jobId])
  @@index([userId])
  @@map("saved_jobs")
}

// Work Experience for employee profiles
model WorkExperience {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  jobTitle        String
  company         String
  companyLogo     String?
  location        String?
  locationType    String?   // remote, onsite, hybrid
  employmentType  String?   // full-time, part-time, contract, internship, freelance
  startDate       DateTime
  endDate         DateTime?
  isCurrent       Boolean   @default(false)
  description     String?
  achievements    String[]
  skills          String[]  // Skills used in this role

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@map("work_experiences")
}

// Education for employee profiles
model Education {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  school          String
  schoolLogo      String?
  degree          String    // Bachelor's, Master's, PhD, etc.
  fieldOfStudy    String
  startDate       DateTime
  endDate         DateTime?
  isCurrent       Boolean   @default(false)
  grade           String?   // GPA or equivalent
  activities      String?   // Extracurricular activities
  description     String?
  achievements    String[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@map("educations")
}

// Certifications and licenses
model Certification {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name              String
  issuingOrg        String
  issuingOrgLogo    String?
  issueDate         DateTime
  expiryDate        DateTime?
  hasNoExpiry       Boolean   @default(false)
  credentialId      String?
  credentialUrl     String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@map("certifications")
}

// Languages spoken
model Language {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  language        String
  proficiency     String   // Native, Fluent, Advanced, Intermediate, Basic

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("languages")
}

// Professional references
model Reference {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  position        String
  company         String
  email           String?
  phone           String?
  relationship    String   // Former Manager, Colleague, Client, etc.

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@map("references")
}

// User notifications
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      String   // application_viewed, application_status, interview_scheduled, message_received, job_alert, offer_received, etc.
  title     String
  message   String
  link      String?  // Optional link to relevant page
  isRead    Boolean  @default(false)

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@map("notifications")
}
